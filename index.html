<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Title</title>
  <style>
    .draggable, .main, .group {
      /* 禁止触摸屏事件 */
      touch-action: none;
      user-select: none;
    }

    .text-center {
      text-align: center;
    }

    .green {
      color: #0b8235;
    }

    .white {
      color: #fff;
    }

    .gray {
      color: #635f63;
    }

    .setting-wrapper {
      width: 100%;
      margin: 0 auto;
    }

    .modal, .add-device-modal {
      display: none;
      position: fixed;
      background-color: rgba(134, 130, 130, 0.8);
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: 1;
    }

    .modal .container {
      text-align: center;
    }

    .add-device-modal .add-device-form {
      position: absolute;
      background-color: #fff;
      left: 50%;
      top: 50%;
      width: 240px;
      height: 160px;
      padding: 10px 50px;
      margin-left: -120px;
      margin-top: -80px;
    }

    .add-device-modal .add-device-form > div {
      margin-top: 10px;
    }

    .add-device-modal .add-device-form .close {
      position: absolute;
      top: 0;
      right: 0;
      padding: 5px;
      margin-top: 10px;
      margin-right: 10px;
    }

    .body {
      display: flex;
      flex-wrap: nowrap;
      align-items: flex-start;
      z-index: 1;
      margin-bottom: 100px;
    }

    .body .operator-wrapper {
      flex-basis: 200px;
      padding: 10px;
      border: 1px solid #ccc;
    }


    .body .operator-wrapper .title {
      position: relative;
      height: 30px;
    }

    .body .operator-wrapper .title .operator-add {
      position: absolute;
      top: 0;
      right: 0;
    }

    .body .operator-wrapper .container {
      min-height: 300px;
      max-height: 500px;
      overflow-y: auto;
    }

    .body .operator-wrapper .container .device-list-wrapper {
      display: flex;
      flex-wrap: wrap;
      width: 200px;
    }

    .body .device-wrapper {
      background-color: #cccccc;
      margin-top: 5px;
      padding: 5px;
    }

    .body .device-wrapper.draggable {
      background-color: #12cc4b;
      cursor: move;
    }

    /* 如果可以拖动,隐藏 div 中的显示按钮位置 */
    .body .operator-wrapper .device-list-wrapper .draggable .show-location {
      display: none;
    }

    .body .main-wrapper {
      border: 1px solid #ccc;
      margin: 10px;
      position: relative;
    }

    .body .main-wrapper .background-image-div {
      background-image: url("./images/6aedf07074a3183023e855c5729757eb--open-kitchen-restaurant-restaurant-layout.jpg");
      background-repeat: no-repeat;
      background-size: 100% 100%;
      z-index: -1;
      position: absolute;
      top: 0;
      left: 0;
    }

    .body .main-wrapper .main {
      background-color: rgba(255, 255, 255, 0.8);
      border: 1px red solid;
      position: relative;
    }

    /* 摆放区的统计显示 */
    .body .main-wrapper .main .group {
      position: absolute;
      top: 0;
      left: 0;
      display: inline-block;
      padding: 2px;
      height: 15px;
      width: 15px;
      font-size: 12px;
      line-height: 25px;
      text-align: right;
      color: red;
      background-image: url("./images/Map_Marker_Ball_Pink_32px_1061216_easyicon.net.png");
      background-repeat: no-repeat;
      background-size: 100% 100%;
    }

    .body .main-wrapper .main .group.highlight{
      background-color: yellow;
    }

    .body .main-wrapper .main .group p {
      background-color: red;
      color: white;
      width: 80px;
      text-align: left;
      padding: 5px;
    }

    .body .main-wrapper .main .group.can-drop {
      color: #000;
      background-color: #4e4;
    }

    .body .main-wrapper .main .group.drop-target {
      background-color: #29e;
      border-color: #fff;
      border-style: solid;
    }

    .body .main .main-device-list-modal {
      background-color: #fff;
      border: 1px solid #cccccc;
      width: 200px;
      padding: 10px;
    }

  </style>
</head>
<body>
<div id="QRModal" class="modal">
  <div class="container">
    <div>
      <button type="button" class="narrow">缩小</button>
      <button type="button" class="enlarge">放大</button>
      <button type="button" class="close">关闭</button>
    </div>
    <img id="qrcode" width="256" src="./images/erCode.png">
  </div>
</div>
<div id="addDeviceModal" class="add-device-modal">
  <div class="add-device-form">
    <div class="close">
      <button type="button" id="closeAddDeviceBtn">X</button>
    </div>
    <div class="text-center">新增设备</div>
    <div>设备名称:<input type="text" id="deviceName" maxlength="50"></div>
    <div>
      选择设备类型:
      <select id="deviceTypeSelect"></select>
    </div>
    <div>
      选择设备位置:
      <select id="devicePositionSelect"></select>
    </div>
    <div class="text-center">
      <button type="button" id="AddDeviceBtn">新增</button>
    </div>
  </div>
</div>
<div id="settingWrapper" class="setting-wrapper">
  <div class="title">设置面积</div>
  <div>
    <div>长:<input type="number" name="roomLength" id="roomLength" value="500"></div>
    <div>宽:<input type="number" name="roomWidth" id="roomWidth" value="800"></div>
    <button type="button" id="changeArea">改变面积大小</button>
  </div>
  <div>
    设置背景图片
    <input type="file" name="backgroundImage" id="backgroundImage" accept="image/*" />
  </div>
  <div>调整背景图片不透明度:<input type="range" name="opacity" id="opacity" min="0" max="1" step="0.1" value="0.8"></div>
</div>

<div class="body">
  <div class="operator-wrapper">
    <div class="title">
      <div class="text-center">
        设备列表
      </div>
      <div class="operator-add">
        <button id="showAddDeviceBtn" type="button">新增</button>
      </div>
    </div>
    <div class="container">
      <div id="deviceListWrapper" class="device-list-wrapper">

      </div>
    </div>

  </div>
  <div id="mainWrapper" class="main-wrapper">
    <div class="main" id="main"></div>
    <div class="background-image-div"></div>
  </div>
</div>
<div class="tips">
  <div>使用说明:
    <p>1. 输出长宽后,点击改变面积按钮,可以改变红框的大小</p>
    <p>2. 可以上传背景图片</p>
    <p>3. 可以设置背景图片的透明度</p>
    <p>4. 点击设备列表中的新增按钮,可以新增设备.</p>
    <p>5. 可以从设备列表拖动到红框中</p>
    <p>6. 红框中的数字,代表在对应位置有多少台设备</p>
    <p>7. 双击红框中的设备数字,可以展开对应位置的设备列表</p>
    <p>7.1 点击隐藏,会将设备列表详情全部隐藏.</p>
    <p>7.2 点击位置设备列表详情中的删除按钮,会将对应设备移除.(移除后可以重新从左边的列表拖进红框)</p>
    <p>8. 坐标的设备列表,点击删除后,会将对应设备删除,并且已摆放的位置也会清空</p>
  </div>
</div>
<script type="text/javascript" src="./js/jquery-1.12.4.min.js"></script>
<script src="./js/interact.min.js"></script>
<script src="./js/draggable.js?v=0.0.4"></script>
<script>
  // 初始化设备列表.如果需要页面加载后显示,则设置该对象的值
  var initDeviceData = [
    {
      // 如果是初始化数据,比如从后端请求的历史数据,ID 建议设置为负数,以免和新增设备时自动生成的 ID 重复
      id: -1,
      name: '张淞\'s 小米米家智能摄像头',
      type: 'camera',
      devicePosition: 'ceiling',
    },
    {
      // 如果是初始化数据,比如从后端请求的历史数据,ID 建议设置为负数,以免和新增设备时自动生成的 ID 重复
      id: -2,
      name: '22张淞\'s 小米米家智能摄像头',
      type: 'camera',
      devicePosition: 'ceiling',
    },
    {
      // 如果是初始化数据,比如从后端请求的历史数据,ID 建议设置为负数,以免和新增设备时自动生成的 ID 重复
      id: -3,
      name: '33张淞\'s 小米米家智能摄像头',
      type: 'camera',
      devicePosition: 'ceiling',
    },
    {
      // 如果是初始化数据,比如从后端请求的历史数据,ID 建议设置为负数,以免和新增设备时自动生成的 ID 重复
      id: -4,
      name: '444\'s 小米米家智能摄像头',
      type: 'camera',
      devicePosition: 'ceiling',
    },
    {
      // 如果是初始化数据,比如从后端请求的历史数据,ID 建议设置为负数,以免和新增设备时自动生成的 ID 重复
      id: -5,
      name: '555\'s 小米米家智能摄像头',
      type: 'camera',
      devicePosition: 'ceiling',
    },
  ];

  // 使用自增 ID 作为每个新增设备的唯一标识
  var deviceSerialNumber = 1;
  var groupSerialNumber = 1;
  // 新增设备时的下拉框选项
  var deviceTypeMap = {
    monitor: '显示器',
    camera: '摄像头',
    sound: '音响',
  };
  // 设备位置
  var devicePositionMap = {
    floor: '地上',
    wall: '墙上',
    ceiling: '天花板上',
  };
  // 当创建一个对象时,最外层 div 的 ID 生成规则
  var deviceWrapperIdTemplate = 'device-@ID';

  // dom 对象
  var backgroundImageDivDom = $('.background-image-div');
  var addDeviceModalDom = $('#addDeviceModal');
  var deviceListWrapperDom = $('#deviceListWrapper');
  var mainDom = $('#main');
  // 设备对象.
  var devices = {};
  // 将初始化数据列表转换为 object,ID 为 key
  for (var index in initDeviceData) {
    var item = initDeviceData[index];
    devices[item.id] = item;
  }

  // 改变面积
  function changeArea() {
    var height = $('#roomLength').val();
    var width = $('#roomWidth').val();
    if (isNaN(height) || height < 300) {
      alert('面积长必须大于300');
      return;
    }
    if (isNaN(width) || width < 300) {
      alert('面积宽必须大于300');
      return;
    }
    mainDom.width(width + 'px').height(height + 'px');
    backgroundImageDivDom.width(width + 'px').height(height + 'px');
  }

  // 清除新增设备表单并关闭模态窗
  function closeAddDeviceModal() {
    $('#deviceName').val('');
    $('#deviceTypeSelect').val('');
    $('#devicePositionSelect').val('');
    addDeviceModalDom.hide();
  }

  // 同步 devices 数组中的值到页面的设备列表
  function syncDevices() {
    for (var key in devices) {
      var item = devices[key];
      if (!item.dom) {
        // 如果对象中不存在 dom 对象,则创建 dom 对象并显示在页面中
        var dom = $(
          '<div class="device-wrapper draggable" id="' + deviceWrapperIdTemplate.replace('@ID', key) + '" data-id="' +
          key + '">' +
          '<div class="device-name"><span class="gray">设备名称:</span><span>' + item.name + '</span></div>' +
          '<div class="device-type"><span class="gray">设备类型:</span><span class="">' + deviceTypeMap[item.type] + '</span></div>' +
          '<div class="device-position"><span class="gray">设备位置:</span><span class="">' + devicePositionMap[item.devicePosition] +
          '</span></div>' +
          '<div><button type="button" class="show-location">查看坐标</button><button type="button" class="show-qr-code">查看二维码</button><button type="button" class="delete">删除</button></div>' +
          '</div>');
        deviceListWrapperDom.append(dom);
        item.dom = dom[0];
      }
    }
  }

  $(function () {
    // 初始化面积 div
    changeArea();
    // 初始化设备下拉框
    var deviceTypeHtml = '';
    for (var item in deviceTypeMap) {
      deviceTypeHtml += '<option value="' + item + '">' + deviceTypeMap[item] + '</option>';
    }
    $('#deviceTypeSelect').html(deviceTypeHtml);
    // 初始化设备位置
    var devicePositionHtml = '';
    for (var item in devicePositionMap) {
      devicePositionHtml += '<option value="' + item + '">' + devicePositionMap[item] + '</option>';
    }
    $('#devicePositionSelect').html(devicePositionHtml);

    // 初始化设备数据
    syncDevices();

    // 改变宽高
    $('#changeArea').on('click', function () {
      changeArea();
    });
    // 设置背景图片透明度
    $('#opacity').on('change', function (e) {
      e.preventDefault();
      mainDom.css('background-color', 'rgba(255, 255, 255, ' + this.value + ')');
    });
    // 设置背景图片
    $('#backgroundImage').on('change', function (e) {
      e.preventDefault();
      var file = this.files[0];
      if (file) {
        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function () {
          var imgSrc = this.result;
          backgroundImageDivDom.css('background-image', 'url(' + imgSrc + ')');
        };
      }
    });
    // 显示二维码模态框
    $('body').on('click', '.show-qr-code', function (e) {
      e.preventDefault();
      // 设备ID
      var id = this.parentNode.parentNode.getAttribute('data-id');
      $('#QRModal').show();
    });
    var QRModalDom = $('#QRModal');
    var qrcodeDom = $('#qrcode');
    // 隐藏二维码模态框
    QRModalDom.on('click', '.close', function (e) {
      $('#QRModal').hide();
    });
    // 缩小
    QRModalDom.on('click', '.narrow', function (e) {
      var width = qrcodeDom.width();
      if (width > 100) {
        qrcodeDom.width(width / 2);
      }
    });
    // 放大
    QRModalDom.on('click', '.enlarge', function (e) {
      var width = qrcodeDom.width() * 2;
      if (width < $(window).width()) {
        qrcodeDom.width(width);
      }
    });

    // 显示新增设备模态框
    $('#showAddDeviceBtn').on('click', function () {
      addDeviceModalDom.show();
    });
    // 关闭新增设备模态框
    $('#closeAddDeviceBtn').on('click', function () {
      closeAddDeviceModal();
    });
    // 新增设备
    $('#AddDeviceBtn').on('click', function () {
      var deviceName = $('#deviceName').val();
      var deviceType = $('#deviceTypeSelect').val();
      var devicePosition = $('#devicePositionSelect').val();
      if (!deviceName) {
        alert('请填写设备名称');
        return;
      }
      if (!deviceType) {
        alert('请选择设备类型');
        return;
      }
      if (!devicePosition) {
        alert('请选择设备位置');
        return;
      }
      var device = {
        id: deviceSerialNumber++,
        name: deviceName,
        type: deviceType,
        devicePosition: devicePosition,
      };
      devices[device.id] = device;
      syncDevices();
      closeAddDeviceModal();
    });
    // 鼠标移入显示设备按钮
    deviceListWrapperDom.on('mouseenter', '.show-location',function (event) {
      event.preventDefault();
      hiddenMainDeviceListModal();
      var parentNode = this.parentNode.parentNode;
      var id = parentNode.getAttribute('data-id');
      debugger;
      var device = devices[id];
      var groupId = device.groupId;
      var groupDom =  document.querySelector('#main div[data-group-id="'+groupId+'"]');
      if(groupDom){
        groupDom.classList.add('highlight');
        groupDom.appendChild($('<p>在这</p>')[0]);
      }
    });
    // 鼠标移出显示设备按钮
    deviceListWrapperDom.on('mouseleave', '.show-location',function (event) {
      event.preventDefault();
      var parentNode = this.parentNode.parentNode;
      var id = parentNode.getAttribute('data-id');
      var device = devices[id];
      var groupId = device.groupId;
      var groupDom =  document.querySelector('#main div[data-group-id="'+groupId+'"]');
      if(groupDom){
        groupDom.classList.remove('highlight');
        groupDom.querySelector('p').remove();
      }
    });

    // 删除设备按钮
    deviceListWrapperDom.on('click', '.delete', function (e) {
      e.preventDefault();
      var wrapperDom = this.parentNode.parentNode;
      var id = wrapperDom.getAttribute('data-id');
      var obj = devices[id];
      if (obj) {
        // 根据ID查询,如果存在对应的选项,则从device中删除,并释放拖拽对象
        var groupId = obj.groupId;
        if (groupId) {
          obj.groupId = null;
          var total = 0;
          for (var key in devices) {
            var device = devices[key];
            if (device.groupId == groupId) {
              total += 1;
            }
          }
          hiddenMainDeviceListModal();
          var dom = mainDom.find('div[data-group-id="' + groupId + '"]');
          if (total > 0) {
            dom.html(total);
          } else {
            dom[0].remove();
          }
        }
      }
      wrapperDom.remove();
    });
  });
</script>
</body>
</html>
